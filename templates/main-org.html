<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    :root {
      --font-brand: 'Poppins', sans-serif;
      --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f4f6f8;
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    .brand {
      font-family: var(--font-brand);
      font-weight: 600;
      font-size: 24px;
      color: var(--brand-color);
    }

    .nav-links button {
      font-family: var(--font-body);
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-links button.active {
      background-color: var(--brand-color);
      color: white;
    }

    .nav-links button:hover {
      transform: translateY(-1px);
    }    .main-content {
      flex: 1;
      padding: 32px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .main-content h2 {
      font-family: var(--font-body);
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 24px;
      font-size: 1.75rem;
    }

    .org-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }

    .org-name {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 16px;
    }

    .org-id {
      color: #4a5568;
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .message {
      text-align: center;
      color: #4a5568;
      font-size: 1.1rem;
      font-weight: 500;
      padding: 24px 0;
      margin: 0;
    }

    .user-icon {
      display: flex;
      justify-content: center;
      padding-top: 10px;
    }

    .user-icon svg {
      width: 24px;
      height: 24px;
      fill: var(--brand-color);
      cursor: pointer;
    }

    .user-icon svg:hover {
      fill: var(--brand-hover);
    }    .schedule-availability-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background-color: var(--brand-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0 0 32px 0;
      position: fixed;
      left: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .schedule-availability-btn:hover {
      background-color: var(--brand-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    #calendar {
      max-width: 1000px;
      margin: 0 auto;
      font-family: var(--font-body);
    }

    #calendar-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3100;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 1000px;
      height: 600px;
      overflow: hidden;
    }

    #calendar {
      height: 100%;
    }

    #calendar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.2);
      z-index: 3000;
      display: none;
    }

    .user-popup {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      min-width: 220px;
    }

    .user-popup strong {
      color: #2d3748;
      font-weight: 600;
    }

    .user-popup button {
      font-family: var(--font-body);
      font-weight: 500;
    }

    .content-area {
      margin-top: 64px; /* Space for the fixed button */
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="brand" onclick="window.location.href='/user-organizations'">ScheduleBuddy</div>
    <div class="nav-links">
      <button onclick="goToPage('main-org')" class="active">Dashboard</button>
      <button onclick="goToPage('org-services')">Services</button>
      <button onclick="goToPage('org-teams')">Teams</button>
      <button onclick="goToPage('org-people')">People</button>
      <button onclick="goToPage('org-messages')">Messages</button>
      <button class="back-btn" onclick="window.location.href='/user-organizations'">My organizations</button>
      <div class="user-icon" id="user-icon-container">
        <svg id="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
        </svg>
        <div id="user-popup" class="user-popup" style="display:none; position:absolute; top:40px; right:0;">
          <p style="margin-bottom:4px;"><strong id="popup-name"></strong></p>
          <p id="popup-email" style="margin-bottom:12px; font-size:14px; color:#555;"></p>
          <button onclick="signOut()" style="width:100%; padding:8px; border:none; background-color:#e74c3c; color:white; border-radius:6px; cursor:pointer;">Sign Out</button>
        </div>
      </div>
    </div>
  </nav>
  <div class="main-content" id="main-content">
    <button class="schedule-availability-btn" onclick="showCalendar()">
      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
        <path fill="currentColor" d="M19 3h-1V2c0-.6-.4-1-1-1s-1 .4-1 1v1H8V2c0-.6-.4-1-1-1s-1 .4-1 1v1H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
      </svg>
      Schedule Your Availability
    </button>
    <p class="message">Loading organization...</p>
  </div>

  <div id="calendar-overlay">
    <div id="calendar-popup">
      <p style="font-weight: bold; margin-bottom: 16px; font-family: var(--font-body);">Please click on the dates you are unavailable</p>
      <div id="calendar"></div>
    </div>
  </div>
  <script>
    // Mark the current page as active in the nav
    document.addEventListener('DOMContentLoaded', () => {
      const currentPath = window.location.pathname.split('/').pop() || 'main-org';
      const navButtons = document.querySelectorAll('.nav-links button');
      navButtons.forEach(button => {
        if (button.textContent.toLowerCase() === 'dashboard' && currentPath === 'main-org') {
          button.classList.add('active');
        } else if (button.onclick && button.onclick.toString().includes(currentPath)) {
          button.classList.add('active');
        }
      });
    });
    const mainContent = document.getElementById('main-content');
const userEmail = localStorage.getItem("user_email");
const firstName = localStorage.getItem("user_first_name") || "";
const lastName = localStorage.getItem("user_last_name") || "";

const userIcon = document.getElementById('user-icon');
const userPopup = document.getElementById('user-popup');
const popupName = document.getElementById('popup-name');
const popupEmail = document.getElementById('popup-email');

popupName.textContent = `${firstName} ${lastName}`;
popupEmail.textContent = userEmail;

userIcon.addEventListener('click', (e) => {
  e.stopPropagation();
  userPopup.style.display = userPopup.style.display === 'none' ? 'block' : 'none';
});

document.addEventListener('click', (e) => {
  if (!document.getElementById('user-icon-container').contains(e.target)) {
    userPopup.style.display = 'none';
  }
});

function signOut() {
  localStorage.removeItem("user_email");
  localStorage.removeItem("user_first_name");
  localStorage.removeItem("user_last_name");
  window.location.href = "https://schedulebuddy.onrender.com/";
}
const urlParams = new URLSearchParams(window.location.search);
  const orgId = urlParams.get("org");

function goToPage(page) {
  if (!orgId) {
    alert("Organization ID is missing.");
    return;
  }
  window.location.href = `/${page}?org=${orgId}`;
}

async function loadUserDashboard() {
  mainContent.innerHTML = `
    <button class="schedule-availability-btn" onclick="showCalendar()">
      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
        <path fill="currentColor" d="M19 3h-1V2c0-.6-.4-1-1-1s-1 .4-1 1v1H8V2c0-.6-.4-1-1-1s-1 .4-1 1v1H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
      </svg>
      Schedule Your Availability
    </button>
    <div>
      <p class="message">Loading your upcoming services...</p>
    </div>`;

  try {
    const [servicesRes, usersRes] = await Promise.all([
      fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`),
      fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`)
    ]);

    const allServices = await servicesRes.json();
    const allUsers = await usersRes.json();

    const user = allUsers.find(u => u.email.toLowerCase() === userEmail.toLowerCase());
    const fullName = `${user.first_name} ${user.last_name}`;
    const now = new Date();

    const upcomingAssignedServices = allServices
      .filter(service => new Date(service.end_datetime) > now)
      .map(service => {
        const myAssignments = [];

        for (const team of service.teams || []) {
          for (const [positionName, assigned] of Object.entries(team.positions || {})) {
            const assignedNames = Array.isArray(assigned) ? assigned : [assigned];

            const matches = assignedNames.some(email => email.toLowerCase() === userEmail.toLowerCase());

            if (matches) {
              myAssignments.push({ team: team.team_name, position: positionName });
            }
          }
        }

        if (myAssignments.length > 0) {
          return {
            ...service,
            assignments: myAssignments
          };
        }

        return null;
      })
      .filter(Boolean);    let content = `      <div>
        <button class="schedule-availability-btn" onclick="showCalendar()">
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
            <path fill="currentColor" d="M19 3h-1V2c0-.6-.4-1-1-1s-1 .4-1 1v1H8V2c0-.6-.4-1-1-1s-1 .4-1 1v1H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
          </svg>
          Schedule Your Availability
        </button>
        <div class="content-area">`;

    if (upcomingAssignedServices.length === 0) {
      content += `<p class="message">You are not scheduled for any upcoming services.</p>`;
      mainContent.innerHTML = content;
      return;
    }    content += `<h2>Your Upcoming Schedule</h2></div></div>`;
    mainContent.innerHTML = content;

    upcomingAssignedServices.forEach(service => {
      const card = document.createElement("div");
      card.className = "org-card";

      const start = new Date(service.start_datetime).toLocaleString();
      const end = new Date(service.end_datetime).toLocaleString();

      const assignmentsText = service.assignments.map(a => `${a.team} - ${a.position}`).join("<br>");

      card.innerHTML = `
        <div class="org-name">${service.service_name}</div>
        <div class="org-id" style="margin-top: 10px;">${assignmentsText}</div>
        <div class="org-id">📍 ${service.location}</div>
        <div class="org-id">🕒 ${start} → ${end}</div>
      `;

      mainContent.appendChild(card);
    });
  } catch (err) {
    console.error("Failed to load dashboard:", err.message);
    mainContent.innerHTML = `<p class="message">Error loading dashboard.</p>`;
  }
}

window.addEventListener("DOMContentLoaded", loadUserDashboard);

let calendarInstance = null;
const selectedDates = new Set();
  
async function showCalendar() {
  const overlay = document.getElementById('calendar-overlay');
  const popup = document.getElementById('calendar-popup');
  overlay.style.display = 'block';
  popup.style.display = 'block';

  overlay.addEventListener('click', function handler(e) {
    if (!popup.contains(e.target)) {
      overlay.style.display = 'none';
      popup.style.display = 'none';
      overlay.removeEventListener('click', handler);
    }
  });

  selectedDates.clear();
  try {
    const res = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`);
    const users = await res.json();
    const user = users.find(u => u.email.toLowerCase() === userEmail.toLowerCase());
    if (user?.inability?.length) {
      user.inability.forEach(d => selectedDates.add(d));
    }
  } catch (err) {
    console.error("Failed to load user's unavailability:", err);
  }

  if (!calendarInstance) {
    calendarInstance = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      selectable: true,
      datesSet(info) {
        calendarInstance.removeAllEvents();
        let date = new Date(info.start);
        while (date < info.end) {
          const dateStr = date.toISOString().split('T')[0];
          calendarInstance.addEvent({
            start: dateStr,
            display: 'background',
            backgroundColor: selectedDates.has(dateStr) ? 'red' : 'lightgreen'
          });
          date.setDate(date.getDate() + 1);
        }
      },
      select(info) {
  const dateStr = info.startStr;

  if (selectedDates.has(dateStr)) {
    selectedDates.delete(dateStr);
    removeInabilityDateFromDatabase(dateStr);
  } else {
    selectedDates.add(dateStr);
    saveInabilityDateToDatabase(dateStr);
  }

  calendarInstance.refetchEvents();
},
      events(fetchInfo, callback) {
        const events = [];
        let date = new Date(fetchInfo.start);
        while (date < fetchInfo.end) {
          const dateStr = date.toISOString().split('T')[0];
          events.push({
            start: dateStr,
            display: 'background',
            backgroundColor: selectedDates.has(dateStr) ? 'red' : 'lightgreen'
          });
          date.setDate(date.getDate() + 1);
        }
        callback(events);
      }
    });
    calendarInstance.render();
  } else {
    calendarInstance.refetchEvents();
  }
}

function hideCalendar() {
  document.getElementById('calendar-overlay').style.display = 'none';
}

function saveInabilityDateToDatabase(dateStr) {
  fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users/inability`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      email: userEmail,
      date: dateStr,
      action: 'add'
    })
  })
  .then(res => {
    if (!res.ok) {
      console.error('Failed to save date', dateStr);
    }
  })
  .catch(err => {
    console.error('Error saving date:', err);
  });
}

function removeInabilityDateFromDatabase(dateStr) {
  fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users/inability`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      email: userEmail,
      date: dateStr,
      action: 'remove'
    })
  })
  .then(res => {
    if (!res.ok) {
      console.error('Failed to remove date', dateStr);
    }
  })
  .catch(err => {
    console.error('Error removing date:', err);
  });
}
</script>
</body>
</html>

