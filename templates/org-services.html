<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Services - ScheduleBuddy</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    :root {
      --font-brand: 'Poppins', sans-serif;
      --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --brand-color: #10245c;
      --brand-hover: #0c1b48;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f4f6f8;
      font-family: var(--font-body);
      color: #2d3748;
      -webkit-font-smoothing: antialiased;
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 32px;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .brand {
      font-family: var(--font-brand);
      font-weight: 600;
      font-size: 24px;
      color: var(--brand-color);
      cursor: pointer;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .nav-links button {
      font-family: var(--font-body);
      font-weight: 500;
      background: none;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      color: #4a5568;
    }

    .nav-links button:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    .nav-links button.active {
      background-color: var(--brand-color);
      color: white;
    }

    .nav-links .back-btn {
      background: var(--brand-color);
      color: #fff;
    }

    .nav-links .back-btn:hover {
      background: var(--brand-hover);
    }

    .user-icon {
      display: flex;
      justify-content: center;
      padding-top: 10px;
    }

    .user-icon svg {
      width: 24px;
      height: 24px;
      fill: var(--brand-color);
      cursor: pointer;
    }

    .user-icon svg:hover {
      fill: var(--brand-hover);
    }

    .main-content {
      flex: 1;
      padding: 32px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-family: var(--font-body);
      font-weight: 600;
      color: #1a202c;
      font-size: 1.75rem;
      margin: 0;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background-color: var(--brand-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-btn:hover {
      background-color: var(--brand-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .action-btn.secondary {
      background-color: #10b981;
    }

    .action-btn.secondary:hover {
      background-color: #059669;
    }

    .action-btn.tertiary {
      background-color: #f59e0b;
    }

    .action-btn.tertiary:hover {
      background-color: #d97706;
    }

    .services-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 24px;
    }

    @media (max-width: 1200px) {
      .services-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .services-grid {
        grid-template-columns: 1fr;
      }
    }

    .service-card {
      background: white;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.05);
      min-height: 280px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .service-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .service-card-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid #f1f5f9;
    }

    .service-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--brand-color), var(--brand-hover));
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .service-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a202c;
      margin: 0;
      line-height: 1.3;
    }

    .service-details {
      padding: 0 24px;
      flex: 1;
    }

    .service-detail-row {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid #f8fafc;
    }

    .service-detail-row:last-child {
      border-bottom: none;
    }

    .detail-icon {
      width: 40px;
      height: 40px;
      background: #f8fafc;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .detail-icon svg {
      width: 20px;
      height: 20px;
      fill: var(--brand-color);
    }

    .detail-content {
      flex: 1;
      min-width: 0;
    }

    .detail-primary {
      font-weight: 600;
      color: #1a202c;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .detail-secondary {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.4;
      word-break: break-word;
    }

    .service-card-footer {
      padding: 16px 24px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }

    .service-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #10b981;
      font-weight: 500;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
    }

    .edit-hint {
      font-size: 0.8rem;
      color: #94a3b8;
      font-style: italic;
    }

    .message {
      text-align: center;
      color: #4a5568;
      font-size: 1.1rem;
      font-weight: 500;
      margin-top: 48px;
    }

    /* Popup Styles */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .popup-title {
      font-family: var(--font-body);
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a202c;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #718096;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: #f7fafc;
      color: #2d3748;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 8px;
      color: #2d3748;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
      color: #2d3748;
      font-family: var(--font-body);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--brand-color);
      box-shadow: 0 0 0 3px rgba(16, 36, 92, 0.15);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 16px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .popup-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .btn-secondary {
      background: #edf2f7;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-primary {
      background: var(--brand-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--brand-hover);
      transform: translateY(-1px);
    }

    .user-popup {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      min-width: 220px;
      z-index: 2000; /* Add high z-index */
    }

    .user-popup strong {
      color: #2d3748;
      font-weight: 600;
    }

    .user-popup button {
      font-family: var(--font-body);
      font-weight: 500;
    }

    /* Teams list styling */
    .teams-list-container {
      margin-top: 8px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .team-checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .team-checkbox:hover {
      background-color: #f7fafc;
    }

    .team-checkbox input {
      margin-right: 10px;
    }

    /* Recurrence options styling */
    .recurrence-container {
      border: 2px solid #e2e8f0;
      padding: 20px;
      border-radius: 10px;
      margin: 16px 0;
      background-color: #f8fafc;
    }

    .weekday-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin: 12px 0;
    }

    .weekday-option {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .weekday-option:hover {
      background-color: #edf2f7;
    }

    .weekday-option input {
      margin-right: 8px;
    }

    /* Scheduler styling */
    .scheduler-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      min-width: 320px;
      max-width: 320px;
    }

    .scheduler-header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .scheduler-service-name {
      font-weight: 600;
      font-size: 1.1rem;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .scheduler-service-info {
      font-size: 0.9rem;
      color: #4a5568;
    }

    .scheduler-team {
      margin-top: 16px;
    }

    .scheduler-team-name {
      font-weight: 600;
      font-size: 1rem;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .scheduler-position-table {
      width: 100%;
      border-collapse: collapse;
    }

    .scheduler-position-table td {
      padding: 6px 4px;
      font-size: 0.9rem;
    }

    .scheduler-position-table select {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.85rem;
      background-color: white;
    }

    /* Calendar preview styling */
    .calendar-preview-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background-color: #f8fafc;
    }

    .calendar-event {
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .calendar-event-title {
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .calendar-event-date {
      font-size: 0.85rem;
      color: #4a5568;
    }

    .export-button {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 20px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .action-buttons {
        width: 100%;
        justify-content: flex-start;
      }

      .services-grid {
        grid-template-columns: 1fr;
      }

      .popup-content {
        padding: 24px;
        margin: 20px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="brand" onclick="window.location.href='/user-organizations'">ScheduleBuddy</div>
    <div class="nav-links">
      <button onclick="goToPage('main-org')">Dashboard</button>
      <button onclick="goToPage('org-services')" class="active">Services</button>
      <button onclick="goToPage('org-teams')">Teams</button>
      <button onclick="goToPage('org-people')">People</button>
      <button onclick="goToPage('org-messages')">Messages</button>
      <button class="back-btn" onclick="window.location.href='/user-organizations'">My organizations</button>
      <div class="user-icon" id="user-icon-container" style="position: relative; z-index: 1500;">
        <svg id="user-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
        </svg>
        <div id="user-popup" class="user-popup" style="display:none; position:absolute; top:40px; right:0;">
          <p style="margin-bottom:4px;"><strong id="popup-name"></strong></p>
          <p id="popup-email" style="margin-bottom:12px; font-size:14px; color:#555;"></p>
          <button onclick="signOut()" style="width:100%; padding:8px; border:none; background-color:#e74c3c; color:white; border-radius:6px; cursor:pointer;">Sign Out</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="main-content" id="main-content">
    <div class="action-buttons" style="position: fixed; left: 16px; top: 100px; z-index: 100; display: flex; gap: 12px;">
      <button class="action-btn" onclick="showCreateServicePopup()" id="create-service-btn" style="display: none;">
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
          <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Create Service
      </button>
      <button class="action-btn secondary" onclick="showScheduleTeamPopup()" id="schedule-team-btn" style="display: none;">
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
          <path fill="currentColor" d="M16 7c0-2.21-1.79-4-4-4S8 4.79 8 7s1.79 4 4 4 4-1.79 4-4zm-4 6c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/>
          <circle fill="currentColor" cx="18.5" cy="8.5" r="2.5"/>
          <path fill="currentColor" d="M24 16v3h-6v-3c0-1.25 2.27-2.5 6-2.5z"/>
        </svg>
        Schedule Team Members
      </button>
      <button class="action-btn tertiary" onclick="showExportSchedulePopup()" id="export-schedule-btn" style="display: none;">
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px;">
          <path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
          <path fill="currentColor" d="M14 14l-3 3-1.5-1.5L8 17l3 3 6-6z"/>
        </svg>
        Export Schedule
      </button>
    </div>

    <div class="page-header" style="margin-bottom: 24px;">
      <!-- Empty header or remove entirely -->
    </div>

    <div class="services-grid" id="services-container" style="padding-top: 60px;">
      <p class="message">Loading services...</p>
    </div>
  </div>

  <!-- Create Service Popup -->
  <div id="create-service-popup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2 class="popup-title">Create New Service</h2>
        <button class="close-btn" onclick="closeCreateServicePopup()">×</button>
      </div>
      <form id="service-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="serviceName">Service Name</label>
            <input type="text" id="serviceName" required />
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" />
          </div>
          <div class="form-group">
            <label for="startDateTime">Start Date & Time</label>
            <input type="datetime-local" id="startDateTime" required />
          </div>
          <div class="form-group">
            <label for="endDateTime">End Date & Time</label>
            <input type="datetime-local" id="endDateTime" required />
          </div>
        </div>
        
        <div class="form-group">
          <label>Assign Teams</label>
          <div class="teams-list-container" id="teams-list"></div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="isRecurring" onchange="toggleRecurrence()" />
          <label for="isRecurring">This service recurs</label>
        </div>

        <div id="recurrence-options" class="recurrence-container" style="display:none;">
          <div class="form-group">
            <label for="recurrencePattern">Recurrence Pattern</label>
            <select id="recurrencePattern">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div style="margin: 16px 0;">
            <label>Repeat every <input type="number" id="repeatInterval" value="1" style="width: 60px; margin: 0 8px;" /> week(s) on:</label>
            <div class="weekday-selector">
              <label class="weekday-option"><input type="checkbox" value="0" /> Sunday</label>
              <label class="weekday-option"><input type="checkbox" value="1" /> Monday</label>
              <label class="weekday-option"><input type="checkbox" value="2" /> Tuesday</label>
              <label class="weekday-option"><input type="checkbox" value="3" /> Wednesday</label>
              <label class="weekday-option"><input type="checkbox" value="4" /> Thursday</label>
              <label class="weekday-option"><input type="checkbox" value="5" /> Friday</label>
              <label class="weekday-option"><input type="checkbox" value="6" /> Saturday</label>
            </div>
          </div>
          <div class="form-group">
            <label>End After <input type="number" id="endOccurrences" value="10" style="width: 60px; margin: 0 8px;" /> occurrences (Max 16 weeks)</label>
          </div>
        </div>

        <div class="popup-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeCreateServicePopup()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Service</button>
        </div>
        <p id="service-message" style="margin-top: 12px; text-align: center;"></p>
      </form>
    </div>
  </div>

  <!-- Schedule Team Members Popup -->
  <div id="schedule-team-popup" class="popup-overlay">
    <div class="popup-content" style="max-width: 1000px;">
      <div class="popup-header">
        <h2 class="popup-title">Schedule Team Members</h2>
        <button class="close-btn" onclick="closeScheduleTeamPopup()">×</button>
      </div>
      <div id="scheduler-wrapper">
        <div id="scheduler-nav" style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
          <button id="prev-scheduler" class="btn btn-secondary" style="padding: 8px 12px;">←</button>
          <div id="scheduler-container" style="display: flex; overflow-x: auto; gap: 16px; flex: 1;"></div>
          <button id="next-scheduler" class="btn btn-secondary" style="padding: 8px 12px;">→</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Schedule Popup -->
  <div id="export-schedule-popup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-header">
        <h2 class="popup-title">Export Schedule Calendar</h2>
        <button class="close-btn" onclick="closeExportSchedulePopup()">×</button>
      </div>
      <div style="margin-bottom: 24px;">
        <p style="color: #4a5568; margin-bottom: 16px;">Choose your export format:</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button class="btn btn-primary export-button" onclick="exportCalendarToPDF()">
            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
              <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
              <path fill="currentColor" d="M8 15h2v1H8zm0-2h6v1H8zm0-2h6v1H8z"/>
            </svg>
            Export to PDF
          </button>
          <button class="btn btn-primary export-button" onclick="exportCalendarToWord()">
            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
              <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
              <path fill="currentColor" d="M9.5 12l1.09 3.26L12 12l1.41 3.26L14.5 12H16l-2.5 6h-1l-1.5-3.5L9.5 18h-1L6 12h1.5z"/>
            </svg>
            Export to Word
          </button>
          <button class="btn btn-primary export-button" onclick="exportCalendarToExcel()">
            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
              <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
              <path fill="currentColor" d="M8 12l2.5 3L8 18h2l1.5-2.25L13 18h2l-2.5-3L15 12h-2l-1.5 2.25L10 12H8z"/>
            </svg>
            Export to Excel
          </button>
        </div>
      </div>
      <div id="calendar-preview" style="margin-top: 24px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Global variables
    const mainContent = document.getElementById('main-content');
    const userEmail = localStorage.getItem("user_email");
    const firstName = localStorage.getItem("user_first_name") || "";
    const lastName = localStorage.getItem("user_last_name") || "";
    const urlParams = new URLSearchParams(window.location.search);
    const orgId = urlParams.get("org");

    let allTeams = [];
    let currentUser = null;
    let isOwner = false;
    let isOrgAdmin = false;
    let userTeamPermissions = [];

    // User popup functionality
    const userIcon = document.getElementById('user-icon');
    const userPopup = document.getElementById('user-popup');
    const popupName = document.getElementById('popup-name');
    const popupEmail = document.getElementById('popup-email');

    popupName.textContent = `${firstName} ${lastName}`;
    popupEmail.textContent = userEmail;

    userIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      userPopup.style.display = userPopup.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById('user-icon-container').contains(e.target)) {
        userPopup.style.display = 'none';
      }
    });

    function signOut() {
      localStorage.removeItem("user_email");
      localStorage.removeItem("user_first_name");
      localStorage.removeItem("user_last_name");
      window.location.href = "https://schedulebuddy.onrender.com/";
    }

    function goToPage(page) {
      if (!orgId) {
        alert("Organization ID is missing.");
        return;
      }
      window.location.href = `/${page}?org=${orgId}`;
    }

    // Initialize page
    async function initPage() {
      try {
        const [orgRes, usersRes] = await Promise.all([
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}`),
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`)
        ]);

        const org = await orgRes.json();
        const allUsers = await usersRes.json();
        currentUser = allUsers.find(u => u.email.toLowerCase() === userEmail.toLowerCase());
        isOwner = org.owner?.email === userEmail;
        isOrgAdmin = currentUser?.org_admin === true;
        userTeamPermissions = currentUser?.team_permissions || [];

        const showScheduleService = isOwner || isOrgAdmin;
        const showTeamScheduler = isOwner || isOrgAdmin || userTeamPermissions.some(tp => tp.permissions.includes("Scheduler"));

        document.getElementById("create-service-btn").style.display = showScheduleService ? "flex" : "none";
        document.getElementById("schedule-team-btn").style.display = showTeamScheduler ? "flex" : "none";
        document.getElementById("export-schedule-btn").style.display = showScheduleService ? "flex" : "none";

        loadServices({ isOwner, isOrgAdmin });
      } catch (err) {
        console.error("Failed to determine user permissions:", err.message);
        loadServices({ isOwner: false, isOrgAdmin: false });
      }
    }

    // Load services
    async function loadServices({ isOwner, isOrgAdmin }) {
      if (!orgId) {
        document.getElementById('services-container').innerHTML = '<p class="message">No org ID provided.</p>';
        return;
      }

      try {
        const res = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`);
        const services = await res.json();
        const now = new Date();
        const upcomingServices = services.filter(service => new Date(service.end_datetime) > now);
        upcomingServices.sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime));

        const container = document.getElementById('services-container');
        container.innerHTML = '';

        if (!upcomingServices.length) {
          container.innerHTML = `<p class="message">No services found. Create your first service to get started.</p>`;
          return;
        }

        upcomingServices.forEach(service => {
          const card = document.createElement('div');
          card.className = 'service-card';

          const startDate = new Date(service.start_datetime);
          const endDate = new Date(service.end_datetime);
          
          // Format dates
          const startDateStr = startDate.toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric' 
          });
          const startTimeStr = startDate.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
          const endTimeStr = endDate.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });

          const teamCount = service.teams?.length || 0;
          const teamNames = service.teams?.map(t => t.team_name).filter(Boolean).join(', ') || 'No teams assigned';

          card.innerHTML = `
            <div class="service-card-header">
              <div class="service-badge">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                  <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
                Service
              </div>
              <h3 class="service-title">${service.service_name}</h3>
            </div>
            
            <div class="service-details">
              <div class="service-detail-row">
                <div class="detail-icon">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path fill="currentColor" d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                  </svg>
                </div>
                <div class="detail-content">
                  <div class="detail-primary">${startDateStr}</div>
                  <div class="detail-secondary">${startTimeStr} - ${endTimeStr}</div>
                </div>
              </div>

              <div class="service-detail-row">
                <div class="detail-icon">
                  <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
                    <path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>
                </div>
                <div class="detail-content">
                  <div class="detail-primary">Location</div>
                  <div class="detail-secondary">${service.location || 'No location specified'}</div>
                </div>
              </div>

              ${(isOwner || isOrgAdmin) ? `
                <div class="service-detail-row">
                  <div class="detail-icon">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 8px;">
                      <path fill="currentColor" d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63c-.34-.81-1.11-1.37-2.01-1.37H16c-.8 0-1.54.37-2.01.99l-3 4.01v7h2v-6h2v6h4z"/>
                      <circle fill="currentColor" cx="12.5" cy="11.5" r="1.5"/>
                      <path fill="currentColor" d="M5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm1.5 16v-7H8.5V9.5c0-.28-.22-.5-.5-.5h-3c-.28 0-.5.22-.5.5V15H6v6h1z"/>
                    </svg>
                  </div>
                  <div class="detail-content">
                    <div class="detail-primary">Teams (${teamCount})</div>
                    <div class="detail-secondary">${teamNames}</div>
                  </div>
                </div>
              ` : ''}
            </div>

            <div class="service-card-footer">
              <div class="service-status">
                <div class="status-indicator"></div>
                <span>Upcoming</span>
              </div>
              <div class="edit-hint">Click to edit</div>
            </div>
          `;

          const userTeams = userTeamPermissions.map(tp => tp.team_name);
          const userRoles = userTeamPermissions.reduce((acc, tp) => {
            acc[tp.team_name] = tp.permissions;
            return acc;
          }, {});

          const relevantTeams = service.teams.map(t => t.team_name);
          const hasAccess = isOwner || isOrgAdmin || relevantTeams.some(team => {
            return userRoles[team]?.length > 0;
          });

          if (hasAccess) {
            card.onclick = () => {
              editService(service, { isOwner, isOrgAdmin, userRoles });
            };
          } else {
            card.style.cursor = "not-allowed";
            card.style.opacity = "0.6";
            card.querySelector('.edit-hint').style.display = 'none';
          }

          container.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        document.getElementById('services-container').innerHTML = '<p class="message">Failed to load services.</p>';
      }
    }

    // Popup functions
    function showCreateServicePopup() {
      document.getElementById('create-service-popup').style.display = 'flex';
      loadTeamsForForm();
      
      // Set default location
      fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}`)
        .then(res => res.json())
        .then(org => {
          const address = [org.address, org.address2, org.city, org.state, org.zip_code]
            .filter(Boolean).join(', ');
          document.getElementById("location").value = address;
        });
    }

    function closeCreateServicePopup() {
      document.getElementById('create-service-popup').style.display = 'none';
      document.getElementById('service-form').reset();
      document.getElementById('service-message').textContent = '';
    }

    function showScheduleTeamPopup() {
      document.getElementById('schedule-team-popup').style.display = 'flex';
      renderTeamScheduler();
    }

    function closeScheduleTeamPopup() {
      document.getElementById('schedule-team-popup').style.display = 'none';
    }

    function showExportSchedulePopup() {
      document.getElementById('export-schedule-popup').style.display = 'flex';
      renderCalendarPreview();
    }

    function closeExportSchedulePopup() {
      document.getElementById('export-schedule-popup').style.display = 'none';
    }

    // Close popups when clicking outside
    document.querySelectorAll('.popup-overlay').forEach(popup => {
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.style.display = 'none';
        }
      });
    });

    // Service form functions
    function toggleRecurrence() {
      const checked = document.getElementById("isRecurring").checked;
      document.getElementById("recurrence-options").style.display = checked ? "block" : "none";
    }

    async function loadTeamsForForm() {
      const res = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/teams`);
      const teams = await res.json();
      const container = document.getElementById("teams-list");
      container.innerHTML = teams.map(t =>
        `<label class="team-checkbox"><input type="checkbox" value="${t.team_name}" /> ${t.team_name}</label>`
      ).join('');
    }

    // Handle service form submission
    document.getElementById('service-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const msg = document.getElementById("service-message");
      msg.textContent = "Submitting...";
      msg.style.color = "#4a5568";

      const selectedTeams = Array.from(document.querySelectorAll("#teams-list input:checked")).map(i => i.value);
      const start = new Date(document.getElementById("startDateTime").value);
      const end = new Date(document.getElementById("endDateTime").value);
      const isRecurring = document.getElementById("isRecurring").checked;
      const location = document.getElementById("location").value;

      const payload = {
        service_name: document.getElementById("serviceName").value,
        start_datetime: start.toISOString(),
        end_datetime: end.toISOString(),
        teams: selectedTeams.map(name => ({ team_name: name, positions: {}, assign_with_other_team: false })),
        location
      };

      try {
        if (isRecurring) {
          const pattern = document.getElementById("recurrencePattern").value;
          const repeat = parseInt(document.getElementById("repeatInterval").value);
          const endAfter = Math.min(16, parseInt(document.getElementById("endOccurrences").value));
          const days = Array.from(document.querySelectorAll("#recurrence-options input[type='checkbox']:checked"))
            .map(i => parseInt(i.value));

          const meetings = [];

          for (let i = 0, date = new Date(start); i < endAfter * 7; i++) {
            const day = date.getDay();
            if (days.includes(day)) {
              const s = new Date(date);
              s.setHours(start.getHours(), start.getMinutes());
              const e = new Date(s);
              e.setHours(end.getHours(), end.getMinutes());

              meetings.push({ ...payload, start_datetime: s.toISOString(), end_datetime: e.toISOString() });
            }
            date.setDate(date.getDate() + 1);
          }

          const safeMeetings = meetings.slice(0, 20);
          for (let m of safeMeetings) {
            await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(m)
            });
          }

          msg.textContent = `Created ${safeMeetings.length} recurring services`;
        } else {
          const res = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Failed to create service.");
          msg.textContent = "Service created successfully!";
        }

        msg.style.color = "#10b981";
        setTimeout(() => {
          closeCreateServicePopup();
          loadServices({ isOwner, isOrgAdmin });
        }, 1500);
      } catch (err) {
        msg.textContent = err.message;
        msg.style.color = "#e53e3e";
      }
    });

    // Team scheduler functionality
    async function renderTeamScheduler() {
      const container = document.getElementById("scheduler-container");
      container.innerHTML = `<div style="text-align: center; color: #4a5568;">Loading scheduler...</div>`;

      try {
        const [services, teams, users] = await Promise.all([
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`).then(r => r.json()),
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/teams`).then(r => r.json()),
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`).then(r => r.json())
        ]);

        const now = new Date();
        const upcoming = services.filter(s => new Date(s.end_datetime) > now)
                                 .sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime));

        const servicesPerPage = 3;
        let currentPage = 0;

        function renderPage() {
          container.innerHTML = '';
          const slice = upcoming.slice(currentPage * servicesPerPage, (currentPage + 1) * servicesPerPage);

          if (slice.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: #4a5568;">No upcoming services to schedule.</div>`;
            return;
          }

          slice.forEach(service => {
            const card = document.createElement('div');
            card.className = 'scheduler-card';

            const userRoles = userTeamPermissions.reduce((acc, tp) => {
              acc[tp.team_name] = tp.permissions;
              return acc;
            }, {});

            const visibleTeams = isOwner || isOrgAdmin
              ? teams
              : teams.filter(t => {
                  const perms = userRoles[t.team_name] || [];
                  return perms.includes("Admin") || perms.includes("Scheduler");
                });

            const teamsHTML = visibleTeams.map(team => {
              const assignedTeam = service.teams.find(t => t.team_name === team.team_name);
              if (!assignedTeam) return '';

              const positionsHTML = team.positions.map(pos => {
                const qty = pos.qty || 1;
                let assigned = assignedTeam.positions?.[pos.position_name];
                if (!Array.isArray(assigned)) assigned = assigned ? [assigned] : [];

                const dropdowns = [];
                for (let i = 0; i < qty; i++) {
                  const assignee = assigned[i] || "";

                  const dropdown = `<select data-team="${team.team_name}" data-position="${pos.position_name}" data-index="${i}" class="scheduler-select">
                    <option value="">-- Select --</option>
                    ${users
                      .filter(u => {
                        const matchesPosition = (u.positions || []).includes(pos.position_name);
                        if (!matchesPosition) return false;

                        const inabilityDates = u.inability || [];
                        const serviceDate = new Date(service.start_datetime).toISOString().split("T")[0];
                        return !inabilityDates.some(date => {
                          const d = new Date(date).toISOString().split("T")[0];
                          return d === serviceDate;
                        });
                      })
                      .map(u => {
                        const fullName = `${u.first_name} ${u.last_name}`;
                        const selected = u.email === assignee ? 'selected' : '';
                        return `<option value="${u.email}" ${selected}>${fullName}</option>`;
                      }).join('')}
                  </select>`;

                  dropdowns.push(`<tr>
                    <td style="padding: 4px; font-size: 14px;">${pos.position_name}</td>
                    <td style="padding: 4px;">${dropdown}</td>
                  </tr>`);
                }

                return dropdowns.join('');
              }).join('');

              return `
                <div class="scheduler-team">
                  <h4 class="scheduler-team-name">${team.team_name}</h4>
                  <table class="scheduler-position-table">${positionsHTML}</table>
                </div>
              `;
            }).join('');

            card.innerHTML = `
              <div class="scheduler-header">
                <div class="scheduler-service-name">${service.service_name}</div>
                <div class="scheduler-service-info">${new Date(service.start_datetime).toLocaleString()}</div>
                <div class="scheduler-service-info">${service.location || 'No location'}</div>
              </div>
              ${teamsHTML}
            `;

            container.appendChild(card);

            // Add event listeners to dropdowns
            const selects = card.querySelectorAll("select");
            selects.forEach(select => {
              select.addEventListener("change", async () => {
                const email = select.value;
                const teamName = select.dataset.team;
                const positionName = select.dataset.position;

                const user = users.find(u => u.email === email);
                const fullName = user ? `${user.first_name} ${user.last_name}` : "";

                const latestRes = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services/${service._id}`);
                const latestService = await latestRes.json();

                const team = latestService.teams.find(t => t.team_name === teamName);
                if (!team) return;

                if (!team.positions[positionName]) team.positions[positionName] = [];
                team.positions[positionName] = email;

                await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services/${service._id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(latestService)
                });
              });
            });
          });
        }

        renderPage();

        document.getElementById('prev-scheduler').onclick = () => {
          if (currentPage > 0) {
            currentPage--;
            renderPage();
          }
        };

        document.getElementById('next-scheduler').onclick = () => {
          if ((currentPage + 1) * servicesPerPage < upcoming.length) {
            currentPage++;
            renderPage();
          }
        };
      } catch (err) {
        container.innerHTML = `<div style="text-align: center; color: #e53e3e;">Failed to load scheduler: ${err.message}</div>`;
      }
    }

    // Calendar preview and export functions
    async function renderCalendarPreview() {
      const preview = document.getElementById("calendar-preview");
      preview.innerHTML = `<div style="text-align: center; color: #4a5568;">Loading calendar preview...</div>`;

      try {
        const [servicesRes, teamsRes, usersRes] = await Promise.all([
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services`),
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/teams`),
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`)
        ]);

        const services = await servicesRes.json();
        const teams = await teamsRes.json();
        const users = await usersRes.json();

        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const upcomingServices = services
          .filter(s => {
            const date = new Date(s.start_datetime);
            return (
              date.getMonth() === currentMonth &&
              date.getFullYear() === currentYear &&
              new Date(s.end_datetime) > now
            );
          })
          .sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime));

        preview.innerHTML = `
          <h3 style="margin-bottom: 16px; color: #1a202c;">Calendar Preview - ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
          <div class="calendar-preview-container">
            ${upcomingServices.length ? 
              upcomingServices.map(s => `
                <div class="calendar-event">
                  <div class="calendar-event-title">${s.service_name}</div>
                  <div class="calendar-event-date">${new Date(s.start_datetime).toLocaleDateString()} at ${new Date(s.start_datetime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
              `).join('') : 
              '<p style="color: #4a5568; text-align: center; padding: 20px;">No services scheduled for this month.</p>'
            }
          </div>
        `;
      } catch (err) {
        preview.innerHTML = `<div style="color: #e53e3e;">Failed to load calendar preview: ${err.message}</div>`;
      }
    }

    function exportCalendarToPDF() {
      alert("PDF export functionality would be implemented here");
    }

    function exportCalendarToWord() {
      alert("Word export functionality would be implemented here");
    }

    function exportCalendarToExcel() {
      alert("Excel export functionality would be implemented here");
    }

    // Edit service function (placeholder)
    function editService(service, { isOwner, isOrgAdmin, userRoles }) {
      const canManageOrg = isOrgAdmin || isOwner;

      const relevantTeams = service.teams.map(t => t.team_name);
      const canSchedule = relevantTeams.some(team => {
        const perms = userRoles[team] || [];
        return perms.includes("Admin") || perms.includes("Scheduler");
      });
        
      const res = fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/teams`)
        .then(res => res.json())
        .then(teams => {
          allTeams = teams;
          
          function toDatetimeLocal(dtString) {
            const dt = new Date(dtString);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            return dt.toISOString().slice(0, 16);
          }
          
          fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/users`)
            .then(res => res.json())
            .then(users => {
              // Create a modern popup for editing service
              const popup = document.createElement('div');
              popup.className = 'popup-overlay';
              popup.style.display = 'flex';
              popup.style.zIndex = '1000';
              
              popup.innerHTML = `
                <div class="popup-content" style="max-width: 700px;">
                  <div class="popup-header">
                    <h2 class="popup-title">Edit Service</h2>
                    <button class="close-btn" onclick="this.closest('.popup-overlay').remove()">×</button>
                  </div>
                  <form id="edit-service-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label><strong>Service Name</strong></label>
                        <input type="text" id="editServiceName" required value="${service.service_name}" ${!canManageOrg ? 'disabled' : ''} />
                      </div>
                      <div class="form-group">
                        <label><strong>Location</strong></label>
                        <input type="text" id="editLocation" value="${service.location || ''}" ${!canManageOrg ? 'disabled' : ''} />
                      </div>
                      <div class="form-group">
                        <label><strong>Start Date & Time</strong></label>
                        <input type="datetime-local" id="editStartDateTime" value="${toDatetimeLocal(service.start_datetime)}" required ${!canManageOrg ? 'disabled' : ''} />
                      </div>
                      <div class="form-group">
                        <label><strong>End Date & Time</strong></label>
                        <input type="datetime-local" id="editEndDateTime" value="${toDatetimeLocal(service.end_datetime)}" required ${!canManageOrg ? 'disabled' : ''} />
                      </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                      <label><strong>Teams & Assignments</strong></label>
                      <div id="team-toggle-list" style="margin: 16px 0;"></div>
                      <div id="assignments-container"></div>
                    </div>

                    <div class="popup-buttons">
                      <button type="button" class="btn btn-secondary" onclick="this.closest('.popup-overlay').remove()">Cancel</button>
                      <button type="submit" class="btn btn-primary">Update Service</button>
                    </div>
                    <p id="edit-service-message" style="margin-top: 12px; text-align: center;"></p>
                  </form>
                </div>
              `;
              
              document.body.appendChild(popup);
              
              if (!service.location) {
                fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}`)
                  .then(res => res.json())
                  .then(org => {
                    const address = [org.address, org.address2, org.city, org.state, org.zip_code]
                      .filter(Boolean).join(', ');
                    document.getElementById("editLocation").value = address;
                  });
              }
              
              function renderTeamTogglesAndAssignments() {
                const toggleList = document.getElementById("team-toggle-list");
                const assignmentsContainer = document.getElementById("assignments-container");

                toggleList.innerHTML = `<label><strong>Enable Teams</strong></label><br/>`;

                allTeams.forEach(team => {
                  const isChecked = service.teams.some(t => t.team_name === team.team_name);

                  const label = document.createElement("label");
                  label.style.marginRight = "12px";
                  label.style.display = "inline-block";
                  label.style.marginBottom = "8px";
                  label.innerHTML = `
                    <input type="checkbox" value="${team.team_name}" ${isChecked ? "checked" : ""} ${!canManageOrg ? "disabled" : ""} />
                    ${team.team_name}
                  `;

                  const checkbox = label.querySelector("input");

                  checkbox.addEventListener("change", () => {
                    if (checkbox.checked) {
                      addTeamAssignment(team);
                    } else {
                      removeTeamAssignment(team.team_name);
                    }
                  });

                  toggleList.appendChild(label);

                  if (isChecked) addTeamAssignment(team);
                });
              }
              
              const form = document.getElementById("edit-service-form");
              if (!canManageOrg && !canSchedule) {
                form.querySelector("button[type='submit']").disabled = true;
                form.querySelector("button[type='submit']").style.opacity = "0.6";
                form.querySelector("button[type='submit']").style.cursor = "not-allowed";
              }

              function addTeamAssignment(team) {
                if (document.getElementById(`team-box-${team.team_name}`)) return;

                const serviceTeam = service.teams.find(t => t.team_name === team.team_name) || {
                  positions: {}
                };
                const role = userRoles[team.team_name] || [];
                const canManageOrg = isOrgAdmin || isOwner;
                const hasAnyPermission = role.length > 0;
                if (!hasAnyPermission && !canManageOrg) return; 
                
                const isViewer = role.includes("Viewer") || role.includes("Messenger");
                const isScheduler = role.includes("Scheduler");
                const isTeamAdmin = role.includes("Admin");

                const canViewOnly = !canManageOrg && isViewer && !isScheduler && !isTeamAdmin;
                const canSchedule = isScheduler || isTeamAdmin;

                const wrapper = document.createElement("div");
                wrapper.id = `team-box-${team.team_name}`;
                wrapper.style.border = "2px solid #e2e8f0";
                wrapper.style.borderRadius = "10px";
                wrapper.style.padding = "16px";
                wrapper.style.marginBottom = "24px";
                wrapper.style.backgroundColor = "#f8fafc";

                const title = document.createElement("h3");
                title.textContent = team.team_name;
                title.style.marginBottom = "12px";
                title.style.color = "#2d3748";

                wrapper.appendChild(title);

                const table = document.createElement("table");
                table.style.width = "100%";
                table.style.borderCollapse = "collapse";

                table.innerHTML = `
                  <thead>
                    <tr>
                      <th style="text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; color: #4a5568;">Position</th>
                      <th style="text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; color: #4a5568;">Assign To</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                `;

                const tbody = table.querySelector("tbody");
                for (let pos of team.positions) {
                  for (let i = 0; i < pos.qty; i++) {
                    const row = document.createElement("tr");

                    const eligibleUsers = users.filter(u =>
                      Array.isArray(u.positions) && u.positions.includes(pos.position_name)
                    );

                    let selectedName = null;
                    const assigned = serviceTeam.positions?.[pos.position_name];
                    if (assigned) {
                      if (Array.isArray(assigned)) selectedName = assigned[i] || null;
                      else if (i === 0) selectedName = assigned;
                    }
                    
                    if (canViewOnly) {
                      row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #edf2f7;">${pos.position_name}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #edf2f7;">${selectedName || "-"}</td>
                      `;
                    } else {
                      const userOptions = eligibleUsers.map(u => {
                        const fullName = `${u.first_name} ${u.last_name}`;
                        const selected = u.email === selectedName ? "selected" : "";
                        return `<option value="${u.email}" ${selected}>${fullName}</option>`;
                      }).join("");

                      row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #edf2f7;">${pos.position_name}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #edf2f7;">
                          <select style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <option value="">-- Select User --</option>
                            ${userOptions}
                          </select>
                        </td>
                      `;

                      const select = row.querySelector("select");
                      select.addEventListener("change", () => {
                        // Handle assignment changes here
                      });
                    }

                    tbody.appendChild(row);
                  }
                }

                wrapper.appendChild(table);
                document.getElementById("assignments-container").appendChild(wrapper);
              }

              function removeTeamAssignment(teamName) {
                const box = document.getElementById(`team-box-${teamName}`);
                if (box) box.remove();
              }

              renderTeamTogglesAndAssignments();
              
              document.getElementById("edit-service-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const msg = document.getElementById("edit-service-message");
                msg.textContent = "Updating...";
                msg.style.color = "#4a5568";

                const updatedTeams = [];

                document.querySelectorAll("#assignments-container > div").forEach(teamDiv => {
                  const teamName = teamDiv.querySelector("h3").textContent;
                  const teamObj = allTeams.find(t => t.team_name === teamName);
                  const assignWithOtherTeam = teamObj?.assign_with_other_team || false;
                
                  const positionAssignments = {};
                
                  teamDiv.querySelectorAll("tbody tr").forEach(row => {
                    const positionName = row.querySelector("td").textContent;
                    const select = row.querySelector("select");
                    if (!select) return;
                    
                    const email = select.value;
                    const fullName = users.find(u => u.email === email);
                    if (email && fullName) {
                      const name = `${fullName.first_name} ${fullName.last_name}`;
                      if (!positionAssignments[positionName]) {
                        positionAssignments[positionName] = name;
                      } else {
                        if (!Array.isArray(positionAssignments[positionName])) {
                          positionAssignments[positionName] = [positionAssignments[positionName]];
                        }
                        positionAssignments[positionName].push(name);
                      }
                    }
                  });
                
                  updatedTeams.push({
                    team_name: teamName,
                    positions: positionAssignments,
                    assign_with_other_team: assignWithOtherTeam
                  });
                });
                
                const payload = {
                  service_name: document.getElementById("editServiceName").value,
                  start_datetime: new Date(document.getElementById("editStartDateTime").value).toISOString(),
                  end_datetime: new Date(document.getElementById("editEndDateTime").value).toISOString(),
                  location: document.getElementById("editLocation").value,
                  teams: updatedTeams
                };

                const res = await fetch(`https://api.worshipbuddy.org/schedulebuddy/organizations/${orgId}/services/${service._id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
                });

                if (res.ok) {
                  msg.textContent = "Service updated!";
                  msg.style.color = "#10b981";
                  setTimeout(() => {
                    popup.remove();
                    loadServices({ isOwner, isOrgAdmin });
                  }, 1500);
                } else {
                  msg.textContent = "Failed to update service.";
                  msg.style.color = "#e53e3e";
                }
              });
            });
        });
    }

    // Initialize the page
    initPage();
  </script>
</body>
</html>
